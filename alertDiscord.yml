---
- name: Report VM Drive Size
  hosts: all
  gather_facts: yes
  vars:
    discord_pw: "$ANSIBLE_VAULT;1.1;AES256
          37376136313466336534616636333434616264396432643265396461613764633261393136316566
          6362363361656463313134333936393031393532663063650a373637616339363132633065313464
          32356366396332633465636438313063353962386633623536303836666237356336326136303738
          6366366136326136320a326165313662356336633438613761346166323634633961613231623933
          33333430636162376665333635313331636436633464623865373630373761346131646530326364
          65623135643537393461323232353134633035343263303139623437663361613863316439616132
          36373235323635666535613735373964336431316634663034353961383864356534386265643461
          36663064656438353730"
  become: yes
  become_method: sudo
  any_errors_fatal: false
  tasks:

    - name: Perform ping in Template
      ping:
    - block:
        - debug:
            var: ansible_play_hosts_all
        - debug:
            var: ansible_play_hosts
        - set_fact:
            down: "{{ ansible_play_hosts_all|difference(ansible_play_hosts) }}"
        - debug:
            var: down
      run_once: true
    - name: Disk usage from command module
      ansible.builtin.shell: "df -k -h --output=pcent / | sed 1d"
      register: size
    - name: Discord Message Title
      run_once: true
      community.general.discord:
        webhook_id: "1269509561749078158"
        webhook_token: "{{discord_pw}}"
        content: "**Nightly VM Disk Consumption Report | {{ '%Y-%m-%d' | strftime }}**"
    - name: Report Disk Percentage to Discord
      community.general.discord:
        webhook_id: "1269509561749078158"
        webhook_token: "{{discord_pw}}"
        content: "{{ansible_hostname}} ({{inventory_hostname}}): {{size.stdout}} full"
    - name: Report Unreachable Hosts to Discord
      run_once: true
      community.general.discord:
        webhook_id: "1269509561749078158"
        webhook_token: "{{discord_pw}}"
        content: "`These Hosts Are Unreachable: {{down}}`"
